<!DOCTYPE html>
<html>
<head>
    <title>System Information Tool - Benign Demo with File Retrieval Examples (Robust Fix)</title>
    <HTA:APPLICATION 
        ID="oHTA"
        APPLICATIONNAME="SysInfoDemo"
        BORDER="thin"
        CAPTION="yes"
        SHOWINTASKBAR="yes"
        SINGLEINSTANCE="yes"
        SYSMENU="yes"
        WINDOWSTATE="normal"/>
</head>
<body>
    <h2>Gathering Local System Information and Demo File Retrieval...</h2>
    <p>Please wait while we collect basic computer details, network config, and demonstrate benign file downloads using XMLHTTP, WinHTTP, and BITS.</p>
    <div id="output"></div>
    <script language="VBScript">
        ' Benign variable setup
        Dim objShell, objFSO, strOutput, strTempPath, objWMI, colItems, objItem
        Set objShell = CreateObject("WScript.Shell")
        Set objFSO = CreateObject("Scripting.FileSystemObject")
        Set objWMI = GetObject("winmgmts:\\.\root\cimv2")

        ' Collect local computer info using WMI (benign query)
        strOutput = "<h3>Local Computer Information:</h3><ul>"
        Set colItems = objWMI.ExecQuery("SELECT * FROM Win32_ComputerSystem")
        For Each objItem in colItems
            strOutput = strOutput & "<li><strong>Computer Name:</strong> " & objItem.Name & "</li>"
            strOutput = strOutput & "<li><strong>User Name:</strong> " & objItem.UserName & "</li>"
        Next
        Set colItems = objWMI.ExecQuery("SELECT * FROM Win32_OperatingSystem")
        For Each objItem in colItems
            strOutput = strOutput & "<li><strong>OS Version:</strong> " & objItem.Caption & " (Build " & objItem.BuildNumber & ")</li>"
        Next
        strOutput = strOutput & "</ul>"

        ' Run PowerShell command for network info (using ipconfig on Windows)
        strTempPath = objShell.ExpandEnvironmentStrings("%TEMP%") & "\netinfo.txt"
        Dim strPSCmd
        strPSCmd = "powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command " & Chr(34) & "ipconfig /all | Out-File -FilePath '" & strTempPath & "' -Encoding UTF8" & Chr(34)
        On Error Resume Next
        objShell.Run strPSCmd, 0, True
        If Err.Number <> 0 Then
            strOutput = strOutput & "<p><strong>Error in ipconfig:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
            Err.Clear
        End If
        On Error Goto 0

        ' Read and append ipconfig output
        If objFSO.FileExists(strTempPath) Then
            Dim objFile
            Set objFile = objFSO.OpenTextFile(strTempPath, 1)
            strOutput = strOutput & "<h3>Network Configuration (ipconfig output):</h3><pre>" & objFile.ReadAll & "</pre>"
            objFile.Close
            objFSO.DeleteFile strTempPath
        Else
            strOutput = strOutput & "<h3>Network Configuration:</h3><p>Output file not found.</p>"
        End If

        ' ========== Benign File Retrieval Examples ==========
        ' Demo URL: Harmless public endpoint (try HTTP first for compatibility)
        Dim strDemoURL, strBaseTemp
        strDemoURL = "http://httpbin.org/get"  ' Switched to HTTP to avoid SSL issues
        strBaseTemp = objShell.ExpandEnvironmentStrings("%TEMP%") & "\"

        ' 1. XMLHTTP Method
        strTempPath = strBaseTemp & "demo_xmlhttp.txt"
        On Error Resume Next
        Dim objXMLHTTP, objADOStream
        Set objXMLHTTP = CreateObject("MSXML2.XMLHTTP")
        If Err.Number <> 0 Then
            strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><p><strong>Error creating XMLHTTP:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
            Err.Clear
        Else
            objXMLHTTP.Open "GET", strDemoURL, False
            If Err.Number <> 0 Then
                strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><p><strong>Error opening request:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
                Err.Clear
            Else
                objXMLHTTP.Send
                If Err.Number <> 0 Then
                    strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><p><strong>Error sending request:</strong> " & Err.Description & " (Code: " & Err.Number & ") - Possible network/SSL issue.</p>"
                    Err.Clear
                ElseIf objXMLHTTP.Status = 200 Then
                    Set objADOStream = CreateObject("ADODB.Stream")
                    If Err.Number <> 0 Then
                        strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><p><strong>Error creating Stream:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
                        Err.Clear
                    Else
                        objADOStream.Open
                        objADOStream.Type = 1
                        objADOStream.Write objXMLHTTP.ResponseBody
                        objADOStream.Position = 0
                        objADOStream.SaveToFile strTempPath, 2
                        If Err.Number <> 0 Then
                            strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><p><strong>Error saving file:</strong> " & Err.Description & " (Code: " & Err.Number & ") - Check %TEMP% permissions.</p>"
                            Err.Clear
                        Else
                            objADOStream.Close
                            Set objFile = objFSO.OpenTextFile(strTempPath, 1)
                            strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><pre>Success! Downloaded to " & strTempPath & "<br/>" & objFile.ReadAll & "</pre>"
                            objFile.Close
                        End If
                    End If
                Else
                    strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><p>Failed (Status: " & objXMLHTTP.Status & " - " & objXMLHTTP.StatusText & ").</p>"
                End If
            End If
        End If
        On Error Goto 0
        If objFSO.FileExists(strTempPath) Then objFSO.DeleteFile strTempPath

        ' 2. WinHTTP Method
        strTempPath = strBaseTemp & "demo_winhttp.txt"
        On Error Resume Next
        Dim objWinHTTP
        Set objWinHTTP = CreateObject("WinHttp.WinHttpRequest.5.1")
        If Err.Number <> 0 Then
            strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><p><strong>Error creating WinHTTP:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
            Err.Clear
        Else
            objWinHTTP.Open "GET", strDemoURL, False
            If Err.Number <> 0 Then
                strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><p><strong>Error opening request:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
                Err.Clear
            Else
                objWinHTTP.Send
                If Err.Number <> 0 Then
                    strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><p><strong>Error sending request:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
                    Err.Clear
                ElseIf objWinHTTP.Status = 200 Then
                    Set objADOStream = CreateObject("ADODB.Stream")
                    If Err.Number <> 0 Then
                        strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><p><strong>Error creating Stream:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
                        Err.Clear
                    Else
                        objADOStream.Open
                        objADOStream.Type = 1
                        objADOStream.Write objWinHTTP.ResponseBody
                        objADOStream.Position = 0
                        objADOStream.SaveToFile strTempPath, 2
                        If Err.Number <> 0 Then
                            strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><p><strong>Error saving file:</strong> " & Err.Description & " (Code: " & Err.Number & ")</p>"
                            Err.Clear
                        Else
                            objADOStream.Close
                            Set objFile = objFSO.OpenTextFile(strTempPath, 1)
                            strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><pre>Success! Downloaded to " & strTempPath & "<br/>" & objFile.ReadAll & "</pre>"
                            objFile.Close
                        End If
                    End If
                Else
                    strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><p>Failed (Status: " & objWinHTTP.Status & " - " & objWinHTTP.StatusText & ").</p>"
                End If
            End If
        End If
        On Error Goto 0
        If objFSO.FileExists(strTempPath) Then objFSO.DeleteFile strTempPath

        ' 3. BITS Method (Simplified with more checks)
        strTempPath = strBaseTemp & "demo_bits.txt"
        Dim strBitsOutputPath, strBitsCmd
        strBitsOutputPath = strBaseTemp & "bits_output.txt"
        ' Simplified command: Direct download and output
        strBitsCmd = "cmd /c powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command " & Chr(34) & _
                     "try { " & _
                     "Import-Module BitsTransfer -ErrorAction Stop; " & _
                     "Start-BitsTransfer -Source '" & strDemoURL & "' -Destination '" & strTempPath & "' -Asynchronous $false; " & _
                     "$content = if (Test-Path '" & strTempPath & "') { Get-Content '" & strTempPath & "' -Raw } else { 'Download failed: File not found' }; " & _
                     "$content } catch { 'BITS Failed: ' + $_.Exception.Message + ' (Line: ' + $_.InvocationInfo.ScriptLineNumber + ')' } | Out-File -FilePath '" & strBitsOutputPath & "' -Encoding UTF8" & Chr(34)
        On Error Resume Next
        Dim intReturn
        intReturn = objShell.Run(strBitsCmd, 0, True)
        If Err.Number <> 0 Then
            strOutput = strOutput & "<h3>3. BITS Download:</h3><p><strong>Shell.Run error:</strong> " & Err.Description & " (Code: " & Err.Number & "; Return: " & intReturn & ")</p>"
            Err.Clear
        ElseIf intReturn <> 0 Then
            strOutput = strOutput & "<h3>3. BITS Download:</h3><p><strong>Command failed:</strong> Exit code " & intReturn & ". BITS often needs admin rights or BITS service running.</p>"
        End If
        On Error Goto 0
        If objFSO.FileExists(strBitsOutputPath) Then
            Set objFile = objFSO.OpenTextFile(strBitsOutputPath, 1)
            Dim strBitsContent
            strBitsContent = objFile.ReadAll
            strOutput = strOutput & "<h3>3. BITS Download:</h3><pre>Output:<br/>" & strBitsContent & "<br/>(Target file: " & strTempPath & ")</pre>"
            objFile.Close
            objFSO.DeleteFile strBitsOutputPath
        Else
            strOutput = strOutput & "<h3>3. BITS Download:</h3><p>Output file not created. Check if BITS service is running (services.msc > Background Intelligent Transfer Service).</p>"
        End If
        If objFSO.FileExists(strTempPath) Then objFSO.DeleteFile strTempPath

        ' Display output in the HTA window
        Document.getElementById("output").innerHTML = strOutput

        ' Optional: Show a message box summary
        MsgBox "Demo completed with error handling! Check the output for details." & vbCrLf & vbCrLf & _
               "If errors persist: Ensure internet access, run as admin for BITS, and check Event Viewer for MSXML/BITS logs.", 64, "Info Complete"

        ' Close after a delay (optional)
        ' window.setTimeout "window.close", 30000
    </script>
</body>
</html>
