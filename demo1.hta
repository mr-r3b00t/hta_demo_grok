<!DOCTYPE html>
<html>
<head>
    <title>System Information Tool - Benign Demo with File Retrieval Examples (Fixed)</title>
    <HTA:APPLICATION 
        ID="oHTA"
        APPLICATIONNAME="SysInfoDemo"
        BORDER="thin"
        CAPTION="yes"
        SHOWINTASKBAR="yes"
        SINGLEINSTANCE="yes"
        SYSMENU="yes"
        WINDOWSTATE="normal"/>
</head>
<body>
    <h2>Gathering Local System Information and Demo File Retrieval...</h2>
    <p>Please wait while we collect basic computer details, network config, and demonstrate benign file downloads using BITS, HTTP, and XMLHTTP.</p>
    <div id="output"></div>
    <script language="VBScript">
        ' Benign variable setup
        Dim objShell, objFSO, strOutput, strTempPath, objWMI, colItems, objItem
        Set objShell = CreateObject("WScript.Shell")
        Set objFSO = CreateObject("Scripting.FileSystemObject")
        Set objWMI = GetObject("winmgmts:\\.\root\cimv2")

        ' Collect local computer info using WMI (benign query)
        strOutput = "<h3>Local Computer Information:</h3><ul>"
        Set colItems = objWMI.ExecQuery("SELECT * FROM Win32_ComputerSystem")
        For Each objItem in colItems
            strOutput = strOutput & "<li><strong>Computer Name:</strong> " & objItem.Name & "</li>"
            strOutput = strOutput & "<li><strong>User Name:</strong> " & objItem.UserName & "</li>"
        Next
        Set colItems = objWMI.ExecQuery("SELECT * FROM Win32_OperatingSystem")
        For Each objItem in colItems
            strOutput = strOutput & "<li><strong>OS Version:</strong> " & objItem.Caption & " (Build " & objItem.BuildNumber & ")</li>"
        Next
        strOutput = strOutput & "</ul>"

        ' Run PowerShell command for network info (using ipconfig on Windows; ifconfig equivalent)
        ' Note: ifconfig is Unix-like; on Windows, ipconfig is used. Output to temp file and read it.
        strTempPath = objShell.ExpandEnvironmentStrings("%TEMP%") & "\netinfo.txt"
        Dim strPSCmd
        strPSCmd = "powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command " & Chr(34) & "ipconfig /all | Out-File -FilePath '" & strTempPath & "' -Encoding UTF8" & Chr(34)
        On Error Resume Next
        objShell.Run strPSCmd, 0, True  ' Run hidden and wait
        If Err.Number <> 0 Then
            strOutput = strOutput & "<p>Network info command failed: " & Err.Description & " (Code: " & Err.Number & ")</p>"
        End If
        On Error Goto 0

        ' Read and append ipconfig output (benign, local only)
        If objFSO.FileExists(strTempPath) Then
            Dim objFile
            Set objFile = objFSO.OpenTextFile(strTempPath, 1)  ' For reading
            strOutput = strOutput & "<h3>Network Configuration (ipconfig output):</h3><pre>"
            strOutput = strOutput & objFile.ReadAll
            strOutput = strOutput & "</pre>"
            objFile.Close
            objFSO.DeleteFile strTempPath  ' Cleanup
        Else
            strOutput = strOutput & "<h3>Network Configuration:</h3><p>Output file not found (command may have failed).</p>"
        End If

        ' ========== Benign File Retrieval Examples ==========
        ' Demo URL: A harmless public text file (e.g., from httpbin.org - returns JSON with request info)
        Dim strDemoURL, strBaseTemp
        strDemoURL = "https://httpbin.org/get"  ' Benign endpoint; returns JSON about the request
        strBaseTemp = objShell.ExpandEnvironmentStrings("%TEMP%") & "\"

        ' 1. XMLHTTP Method (MSXML2.XMLHTTP - simple GET for small files)
        strTempPath = strBaseTemp & "demo_xmlhttp.txt"
        Dim objXMLHTTP, objADOStream
        Set objXMLHTTP = CreateObject("MSXML2.XMLHTTP")
        objXMLHTTP.Open "GET", strDemoURL, False
        objXMLHTTP.Send
        If objXMLHTTP.Status = 200 Then
            Set objADOStream = CreateObject("ADODB.Stream")
            objADOStream.Open
            objADOStream.Type = 1  ' Binary (works for text too)
            objADOStream.Write objXMLHTTP.ResponseBody
            objADOStream.Position = 0
            objADOStream.SaveToFile strTempPath, 2  ' Overwrite
            objADOStream.Close
            ' Read and display
            Set objFile = objFSO.OpenTextFile(strTempPath, 1)
            strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><pre>Downloaded via MSXML2.XMLHTTP to " & strTempPath & "<br/>" & objFile.ReadAll & "</pre>"
            objFile.Close
        Else
            strOutput = strOutput & "<h3>1. XMLHTTP Download:</h3><p>Failed (Status: " & objXMLHTTP.Status & ").</p>"
        End If
        If objFSO.FileExists(strTempPath) Then objFSO.DeleteFile strTempPath

        ' 2. HTTP Method (WinHttp.WinHttpRequest - alternative HTTP client)
        strTempPath = strBaseTemp & "demo_winhttp.txt"
        Dim objWinHTTP
        Set objWinHTTP = CreateObject("WinHttp.WinHttpRequest.5.1")
        objWinHTTP.Open "GET", strDemoURL, False
        objWinHTTP.Send
        If objWinHTTP.Status = 200 Then
            Set objADOStream = CreateObject("ADODB.Stream")
            objADOStream.Open
            objADOStream.Type = 1
            objADOStream.Write objWinHTTP.ResponseBody
            objADOStream.Position = 0
            objADOStream.SaveToFile strTempPath, 2
            objADOStream.Close
            ' Read and display
            Set objFile = objFSO.OpenTextFile(strTempPath, 1)
            strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><pre>Downloaded via WinHttp.WinHttpRequest to " & strTempPath & "<br/>" & objFile.ReadAll & "</pre>"
            objFile.Close
        Else
            strOutput = strOutput & "<h3>2. WinHTTP Download:</h3><p>Failed (Status: " & objWinHTTP.Status & ").</p>"
        End If
        If objFSO.FileExists(strTempPath) Then objFSO.DeleteFile strTempPath

        ' 3. BITS Method (Via PowerShell - BITS jobs for background/resumable transfers; benign small file)
        ' Fixed: Use Chr(34) for quotes, wrap in cmd /c, add error handling
        strTempPath = strBaseTemp & "demo_bits.txt"
        Dim strBitsOutputPath, strBitsCmd
        strBitsOutputPath = strBaseTemp & "bits_output.txt"
        strBitsCmd = "cmd /c powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command " & Chr(34) & _
                     "try { Start-BitsTransfer -Source '" & strDemoURL & "' -Destination '" & strTempPath & "' -Asynchronous $false; " & _
                     "if (Test-Path '" & strTempPath & "') { Get-Content '" & strTempPath & "' | Out-String } else { 'Download failed' } } " & _
                     "catch { 'BITS Failed: ' + $_.Exception.Message } | Out-File -FilePath '" & strBitsOutputPath & "' -Encoding UTF8" & Chr(34)
        On Error Resume Next
        Dim intReturn
        intReturn = objShell.Run(strBitsCmd, 0, True)  ' Run hidden and wait; capture return code
        If Err.Number <> 0 Then
            strOutput = strOutput & "<h3>3. BITS Download:</h3><p>Command execution failed: " & Err.Description & " (Code: " & Err.Number & "; Return: " & intReturn & ")</p>"
        ElseIf intReturn <> 0 Then
            strOutput = strOutput & "<h3>3. BITS Download:</h3><p>Command returned non-zero: " & intReturn & " (Possible BITS permission issue - run as admin?)</p>"
        End If
        On Error Goto 0
        If objFSO.FileExists(strBitsOutputPath) Then
            Set objFile = objFSO.OpenTextFile(strBitsOutputPath, 1)
            strOutput = strOutput & "<h3>3. BITS Download:</h3><pre>Downloaded via Start-BitsTransfer to " & strTempPath & "<br/>" & objFile.ReadAll & "</pre>"
            objFile.Close
            objFSO.DeleteFile strBitsOutputPath
        Else
            strOutput = strOutput & "<h3>3. BITS Download:</h3><p>Output file not found (BITS may require admin rights or fail on HTTPS).</p>"
        End If
        If objFSO.FileExists(strTempPath) Then objFSO.DeleteFile strTempPath

        ' Display output in the HTA window
        Document.getElementById("output").innerHTML = strOutput

        ' Optional: Show a message box summary (benign notification)
        MsgBox "System info and file retrieval demos completed! Check the window for details." & vbCrLf & vbCrLf & _
               "Note: BITS often needs admin privileges; if it failed, try running the HTA as administrator.", 64, "Info Complete"

        ' Close after a delay (optional, for demo)
        ' window.setTimeout "window.close", 30000  ' Uncomment to auto-close after 30s
    </script>
</body>
</html>
